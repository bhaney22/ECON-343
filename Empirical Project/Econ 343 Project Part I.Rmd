---
title: "Empirical Project PART I: **Add lastname, firstname **"
output:
  pdf_document:
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
    toc_collapsed: yes
    toc_float: yes
    toc_levels: 4
---

```{r setup, include=FALSE}
#
# Always include these packages in R projects for this class
#
library(dplyr)      # for filter and select commands. etc.
library(wooldridge) # datasets in the textbook
library(stargazer)  # nice regression output
library(ggformula)  # easy graphing interface for ggplot
library(expss)      # apply_labels() cro()
library(car)        # for linearhypothesis tests lht(), predict() hccm() heterosced.
library(dynlm)      # lm commands for time series data
library(plm)        # lm commands for panel data


options(digits=4)   # limits number of decimals to 4 when printing

knitr::opts_chunk$set(echo = TRUE) # TRUE = commands in r chunks to be echoed in outfile

```


## Select variables from the dataset



```{r}
rm(list = ls())
## 
## >>>> Add additional variables to the list below as needed
## >>>> Don't forget to put the variable name in quotes and put a comma between each one
##
myvars    <- c("AGE", "RACE", "SEX", "MARITAL", "CHILDS",
             "REGION", "SIZE","EDUC","DEGREE","WRKSTAT","HRS1","TAX",
             "PARTYID","PRES16","NATFARE","COURTS","INCOME16")

varlist <- c("YEAR", "ID", "WTSSALL",
             myvars)

load("GSS2018.Rdata") 

mygss <- tmp.spss %>% select(all_of(varlist))

rm(tmp.spss)
 
 
stargazer(mygss,type="text",
          digits = 0, 
          summary.stat = c("n","min","max","median","mean","sd"),
          title = "MYGSS")

```

## Frequencies


```{r}

mygss %>% 
  select(-YEAR,-ID,-WTSSALL,-AGE,-SIZE,-HRS1) %>%
  sjmisc::frq(show.na = FALSE,weights = mygss$WTSSALL)


```

### Recodes
```{r}

mygss$RACE


```


```{r}
lm1 <- lm()

```


## Create new variables 

- You will often want to create new variables so that you can
reduce the number of categories of a variable. 
- Be sure to
document what the categories mean so that you can
label them correctly.
- Use `mutate()` with `case_when()` to collapse several categories into a few

Usage:

datasetname <- datasetname %>%
     mutate(**newvarname** = 
     case_when(condition 1 ~ value if condition 1 holds, 
     condition * ~ value if condition 2 holds))


The following code chunk creates new variables *party*, *region*, *labor force status*, and *agegrp* by collapsing the values of PARTYID, REGION, WRKSTAT, and AGE into a smaller number of categories, using the category cutoffs in the GSS Trend Graphs.

UPDATE: 7.11.2020 - use labels for the recoded values, rather than numbers
UPDATE: 7.11.2020 - use 0/1 (not characters) when creating dummy variables

``` {r}

# The GSS variable PARTYID was recoded 
# into four categories: (0)-(1) Democrat; (2)-(4),(7) Independent, Other; and (5)-(6) 
# Republican. 

# The GSS variable REGION was recoded into four categories: (1)-(2) Northeast; 
# (3)-(4) Midwest; 
# (5)-(7) South; (8)-(9) West. These are in alignment with the Census regional groupings.

# The GSS variable WRKSTAT was recoded into three categories: 
# (1)-(3) Employed, (4) Unemployed, 
# and (5)-(8) Not in labor force/Other. 
# This is in alignment with the Bureau of Labor Statistic's labor force definitions.

mygss <- mygss %>%
  mutate(party = case_when(PARTYID == 5 | PARTYID == 6 ~ "Republican",      
                           PARTYID == 0 | PARTYID == 1 ~ "Democrat",      
                           PARTYID >= 2 & PARTYID <= 4 ~ "Independent",      
                           PARTYID == 7 ~ "Independent"),
         
         trump = case_when(PRES16 == 2 ~ "Voted Trump",      
                           PRES16 == 1 ~ "Voted Clinton"),
         
         region = case_when(REGION == 1 | REGION == 2 ~ "NE",     
                              REGION == 3 | REGION == 4 ~ "Midwest",    
                              REGION == 5 | REGION == 6 | REGION == 7 ~ "South", 
                              REGION == 8 | REGION == 9 ~ "West"),    
         
         # LFS = Labor Force Status
         lfs    = case_when(WRKSTAT <= 3 ~ "Employed",                    
                            WRKSTAT == 4 ~ "Unemployed",                    
                            WRKSTAT > 4 & WRKSTAT < 9 ~ "OLF"),      

         agegrp = case_when(AGE >= 18 & AGE <= 34 ~ "Age 18-34",
                            AGE >= 35 & AGE <= 49 ~ "Age 35-49" ,
                            AGE >= 50 & AGE <= 64 ~ "Age 50-64",
                            AGE >= 65 ~ "Age 65+")
  )


```

**Dummy variables**

Dummy variables are "0/1" variables, with value = 1 if the variable is true
and value = 0 if the variable is false

- give dummy variables values of 0/1 rather than categorical names.

``` {r}

                              
mygss <- mygss %>%         
          mutate(married  = case_when(MARITAL == 1 ~ "Married",
                              MARITAL  > 1 ~ "Not Married"),
          haschild = case_when(CHILDS   > 0 ~ "Has child", 
                               CHILDS == 0 ~ "No children")
  )



lm1 <- lm(INCOME16 ~ married + haschild + SEX,data = mygss)
stargazer(lm1,type= "text")
```


## Label variables
Variable labels are important for making tables and results "human readable". 

Use `apply_labels()` to:

- Name or rename variables

Usage:

- datasetname <- **apply_labels**(datasetname,*var1* = "var label 1")



``` {r}
mygss <-  apply_labels(mygss,
    party  = "Political Party",
    region = "Region",
    lfs    = "Labor Force Status",
    agegrp     = "Age",
    married    = "Married",
    haschild   = "Has Children"
  )
```



# Get set!

Take stock of the variables you have to work with. 



# Go! 

Explore the variables to:

- Look for statistically signficiant differences across groups
- Look for particularly important control variables

## Add statistical significance to R tables:

- use `cro_cpct()` with two variables
- add the pipe command `%>%`
- add the `significance_cpct()` option 
to display statistical signficance between columns

How to read the table:

- the table columns are labeled with letters. 
- the letters next to a value in the table indicates that the value of the variable for this group is statistically significantly larger than the value for the group in a different column.

## Voting example
``` {r}

cro_cpct(mygss$party,mygss$PRES16) %>% 
  significance_cpct() %>%
  drop_rc() %>%
  split_table_to_df() %>%
  knitr::kable()

```

This table was a helpful "reality check" for me. When I ran this the very first
time, I noticed quite a few democrats voted for Trump, Hm. I went back and checked my re-codes. Sure enough, I had mis-coded one value.

## COURTS example

Suppose you want to see if
beliefs about *COURTS* appear to be related to the *region* of the
respondent
``` {r}
cro_cpct(mygss$COURTS,mygss$region) %>% 
  significance_cpct() %>%
  drop_rc() %>%
  split_table_to_df() %>%
  knitr::kable()

```

It appears that the percent of respondents in the Midwest that believe courts are 
"about right" is statistically significantly lower than all other regions. The
percent in the 
Midwest that believe courts are "not harsh enough" is higher than all other regions,
but that difference is not statistically significant.


## %nest% command

Are the differences statistically significant after controlling for race?

Use the %nest% command to compare categories within another category

Usage:

- cro(*row variable*, *top level* %nest% *bottom level* )

``` {r}
cro_cpct(mygss$NATFARE, mygss$RACE %nest%  mygss$region) %>%   
  significance_cpct() %>%
    drop_rc() %>%
  split_table_to_df() %>%
  knitr::kable()

```

After controlling for race, it appears that the percentage of whites in the Midwest
how believe courts are "not harsh enough" is statistically significantly 
greater than the percent of whites in other regions. What do you notice in these
results?



# Your turn

What relationships do you want to explore? Choose one that you find interesting
and share it on the Community Learning forum this week. You can take a screen shot
of the table, or print the html page as a .pdf and upload it to the post.

You might want to recode some of the variables differently. Or, you might even want
to explore the GSS for additional variables. You can add new variables from the
GSS by adding their name to the "select()" statement when reading in the dataset.

``` {r}



```


# Save the final version of your mygss file so you can use it in your report.

UPDATE: 7.11.2020 - Save the file you created during the exploratory
analysis and then read it in at the start of your final empirical project report.

```{r}
save(mygss,file="mygss.RData")

```

