---
title: "Econ 343 Empirical Project lastname, firstname"
output:
  pdf_document:
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
    toc_collapsed: yes
    toc_float: yes
    toc_levels: 2
---

```{r setup, include=FALSE}
#
# Always include these packages in R projects for this class
#
library(readr)      # for reading in .csv files
library(tidyverse)  # data wrangling
library(dplyr)      # for filter and select commands. etc.

library(wooldridge) # datasets in the textbook
library(stats)      # basic statistic commands
library(DataExplorer) # nice commands to learn about a new data set
library(stargazer)  # nice regression output
library(ggformula)  # easy graphing interface for ggplot
library(mosaic)     # accompanies ggformula
library(expss)      # apply_labels() cro()

library(AER)        # data and commands specific to econometrics
library(car)        # for linearhypothesis tests lht(), predict() hccm() heterosced.
library(lmtest)     # post-reg tests coeftest()
library(effects)    # to plot effects of one regressor, holding all others constant
library(visualize)  # to visualize hypothesis test p-values

library(dynlm)      # lm commands for time series data
library(plm)        # lm commands for panel data


options(digits=4)   # limits number of decimals to 4 when printing

knitr::opts_chunk$set(echo = TRUE) # TRUE = commands in r chunks to be echoed in outfile
```

# Project Summary

{Instructions for Project Summary: Fill in the bold aspects of the 5 parts of empirical analysis below. For each bullet point, provide a sentence or two of description or explanation.}

*1. Economic Question*

**economic question**

- Explain briefly why this question is interesting using infographic, statistics, and opinion articles. 

*2. Economic Model*

**$$\textbf{dependent variable} = f(\textbf{list of explanatory variables})$$**

- Use the research paper you found to help explain the list of explanatory variables.

*3. Econometric Model*

**$$depvar = \beta_0 + \beta_1 xvar_1 + \beta_2 xvar_2 + ... + u $$**

- describe your econometric model in words 

*4. Data*

 **summary table of basic descriptive statistics** for each variable
 
- Define each of the variables.

*5. Results*

**table of final regression results**

- Describe the main findings


# Introduction
{Instructions: For this and all subsequent sections, follow the directions and use the question prompts to help guide what needs to be written up. The example dataset and commands that are provided in the R chunks below are to demonstrate the types of commands you will need to use with your data. The examples should be deleted in the final report.}


- In this section of the project, describe the **economic question** you
are exploring. Explain why this 
question is interesting using statistics, graphs, and the variety of opinions you found.

- Present the **economic model**. What is the dependent variable of interest? 
What are the explanatory variables in the model?


- Briefly summarize what is known so far based on your literature review. 
Make sure you add every citation to your econ343*name*.bib file and include
them in the write-up. Follow the 
instructions in the Lecture regarding Zotero. Find further suggestions in
the Wooldridge.

- Describe in detail how your primary paper contributes to understanding this
question. What does it conclude? What data does it use? 

- Evaluate the paper. How robust are its conclusions? What are the strengths 
and limitations of the data and methods. 

- Set up the motivation
for how you modify in the model for your second set of results.

- Briefly explain how your new model differs from the first model. 

- Briefly summarize the result of your comparison.

# Data

Fully describe the data that you are using. What are the questions
that created the variables? What is the time frame? Who are the 
respondents? 

If using the GSS, make sure to cite the data source using a footnote.\footnote{Smith, Tom W., Davern, Michael, Freese, Jeremy, and Morgan, Stephen, General Social Surveys, 1972-2018 [machine-readable data file] /Principal Investigator, Smith, Tom W.; Co-Principal Investigators, Michael Davern, Jeremy Freese, and Stephen Morgan; Sponsored by National Science Foundation. --NORC ed.-- Chicago: NORC, 2018: NORC at the University of Chicago [producer and distributor]. Data accessed from the GSS Data Explorer website at gssdataexplorer.norc.org.}

## Description
- What are these data? Where were they obtained? How were the data  
sampled (the "sampling frame"). 

- Define the primary dependent variable(s) and explanatory variables. 

- Explain how these variables are operationalized in the dataset.


``` {r}

# Dataset for illustrative examples used in the template

mydata <- mtcars # for this template I use the mtcars data to illustration

# 2. Select the variables you need, and optionally, a subset of the observations.

# For example, restrict analysis to only 6 cylinder cars and drop that variable
# mydata <- mtcars %>% 
#  filter(cyl==6) %>%  
#  select(-cyl)

# 3. Provide meaningful names for variables. Give meaningful labels to values of
#    categorical variables. R will treat them as factors automatically.

mydata <- apply_labels(mydata,
#Label quantiative Variables:
                      mpg = "Miles/gallon",
                      disp = "Displacement (cu.in.)",
                      hp = "Gross horsepower",
                      drat = "Rear axle ratio",
                      wt = "Weight (1000 lbs)",
                      qsec = "1/4 mile time",
                      gear = "Number of forward gears",
                      carb = "Number of carburetors",

# Categorical Variables:                      
                      cyl = "Number of cylinders",
                      cyl = c("4 cyl" = 4,
                              "6 cyl" = 6,
                              "8 cyl" = 8),
                      vs = "Engine",
                      vs = c("V-engine" = 0,
                             "Straight engine" = 1),
                      am = "Transmission",
                      am = c("Automatic" = 0,
                             "Manual"=1)
)

# 4. It is common that a dataset will have "row names" that identify observations. 
# You can check this with the command "rownames(mydata)". 
# If so, you should add the rownames as an additional column in the dataset using
# the following command.

mydata <- rownames_to_column(mydata,var="Name of Car")


# 5. Create new variables as needed.
#    For example, create a new categorical variable based on values of a continuous variable
mydata$heavy <- NULL
mydata$heavy[mydata$wt <  mean(mydata$wt)] = 0
mydata$heavy[mydata$wt >= mean(mydata$wt)] = 1

# Give the values of the new categorical variable meaningful labels
mydata$heavy <- factor(mydata$heavy,
  levels = c(0,1),
  labels = c("Below Avg","Above Avg"))

```

* Explicitly document and explain all of the steps you took to get the data into 
usable form for analysis. 

* The package ***dplyr*** has most of the commands you need for data wrangling and summarizing
click here for the dplyr cheatsheet 
[https://github.com/rstudio/cheatsheets/blob/master/data-transformation.pdf]
  + Select & Filter commands
  + Add labels for variables 
  + Create categorical variables (factors)
  + Define names for each of the values in the factor (factor levels)
  + Create dummy variables
  + Create other variables
  + etc.
  
  
## Compare Means across one category

```{r}

# summary statistics
# commands from expss package

mydata %>%
  tab_cells(mpg, disp, hp, wt, qsec) %>%   # cells -> continuous variables
  tab_cols(am) %>%                         # columns -> categories 
  tab_stat_mean_sd_n() %>%
  tab_last_sig_means() %>%                 # test for significant differences 
  tab_pivot()
```


## Compare Means across nested categories

```{r}
mydata %>%
  tab_cells(mpg, disp, hp, wt, qsec) %>%              
  tab_cols(vs %nest% am)    %>%            # "nested" columns -> categories within categories
  tab_stat_mean_sd_n() %>%
  tab_last_sig_means() %>%
  tab_pivot()

```


## Cross-tabs
Do the means remain statistically significantly different if we control for engine type?

```{r}
mydata %>%
  calc_cro_cpct_responses(list(vs),              # first list are categories for the rows
                          list(am,total())) %>%  # second list are categories for columns
  significance_cpct()                            # test for significant differences
```

## Correlations

```{r}

# Provide a "heatmap" of correlations to examine how variables are correlated with
# the dependent variable and with each other, without controlling for anything else.

cor1 <- mydata %>% 
  select(mpg,hp,disp,qsec,wt)
  plot_correlation(cor1, title="Correlations of car characteristics")

```

Examine relationships between categorical
variables is to create tables that show how the distribution across categorical 
variables and compare means across groups. 

For example, suppose the economic question is to examine if manual 
transmissions are still significantly more gas efficient than automatic transmissions, after controlling for other characteristics.

``` {r}
gf_point(mpg ~ wt, data = mydata) %>%
  gf_lm()

```

# Analysis


## Initial Model Results

```{r}

lm1 <- lm(mpg ~ am + disp + hp + wt,mydata)
stargazer(lm1,type="text")

```

- Present initial model. Either replicate the key regresssion results from the research, 
or create your own "initial"
regression results from data. 

- Explain in your
own words what the estimated coefficients mean, and the conclusion about
the economic question
that can be drawn from the regression.


## New Model Results

```{r}
lm2 <-lm(mpg ~ am + disp + hp + wt + am*wt,mydata)
stargazer(lm1,lm2,type="text")

```


- Modify the model in some way by operationalizing an explanatory variable in a different
way, adding new explanatory variables, or using a different regression method.

- Fully explain the different data and methods that you use. 

- Run the new analysis.

- Compare and contrast the results of the two models.

## Check Assumptions

- Check for normality and heteroscedasticity so that post-regression inference is valid.

### Normally Distributed?
```{r}

qqPlot(lm1)
qqPlot(lm2)

```


### Heteroscedasticity?

```{r}

bptest(lm1)
bptest(lm2)

```

- Use the Brausch-Pagan Test to
test for the presence of heteroscedasticity in your new model.

- Discuss the results.


## Post-Regression Analysis

### Graphs of Marginal Effects

```{r}
plot(effect("am",lm1))
plot(effect("am",lm2))
```

### Linear Hypothesis Tests

```{r}

lht(lm1,c("disp=hp"))
lht(lm1,c("disp=hp"),white.adjust = TRUE)
lht(lm2,c("disp=hp"))
lht(lm2,c("disp=hp"),white.adjust = TRUE)

```

- Compare the effect of the primary explanatory variable on the dependent variable between the 
two models. 

- Run at least one post-regression linear hypothesis test.

- Perform tests with and without correcting for heteroscedasticity. And discuss any
differences you find.

# Conclusion

- In this last section:
  + Restate the economic question
  + Explain how the primary empirical paper contributed to understanding that
  question.
  + Describe how you extended their results and what you learned
  + Conclude with suggestions of additional questions that would be
  interesting to pursue based on what you found.
  
# References
